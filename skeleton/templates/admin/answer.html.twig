{% extends 'admin/base_admin.html.twig' %}

{% block title %}Admin - Respuestas - TalaTrivia{% endblock %}

{% block content %}
	<div class="d-flex justify-content-between align-items-center mb-3">
		<h2>Respuestas</h2>
		<button class="btn btn-success" id="btnAbrirRespuesta" type="button" data-bs-toggle="modal" data-bs-target="#respuesta">Crear Respuesta</button>
	</div>

	{% if answers is empty %}
		<div class="alert alert-info">No hay Respuestas aún.</div>
	{% else %}
			
		<table class="table table-striped table-hover rounded-lg overflow-hidden shadow">
			<thead class="bg-gray-800 text-white">
				<tr>
					<th class="py-3 px-4">ID</th>
					<th class="py-3 px-4">Pregunta</th>
					<th class="py-3 px-4">Respuesta</th>
					<th class="py-3 px-4">¿Es Correcta?</th>
					<th class="py-3 px-4">Acciones</th>
				</tr>
			</thead>
			<tbody>
				{% for c in answers %}
					<tr>
						<td class="py-2 px-4">{{ c.id }}</td>
						<td class="py-2 px-4">{{ c.question.text|length > 50 ? c.question.text|slice(0, 50) ~ '...' : c.question.text }}</td>
						<td class="py-2 px-4">{{ c.text }}</td>
						<td class="py-2 px-4">
							{% if c.is_correct %}
								<span class="badge bg-success text-white">Sí</span>
							{% else %}
								<span class="badge bg-secondary">No</span>
							{% endif %}
						</td>
						<td class="py-2 px-4 d-flex gap-2">
							<button type="button" 
									class="btn btn-sm btn-outline-primary btn-edit" 
									data-id="{{ c.id }}" 
									data-text="{{ c.text }}" 
									data-is-correct="{{ c.is_correct ? 1 : 0 }}" 
									data-question-id="{{ c.question.id }}" 
									data-bs-toggle="modal" 
									data-bs-target="#respuestaEdit" 
									style="width: 70px;">
								Editar
							</button>
							<button onclick="eliminarRespuesta('{{ path('answer_delete', {id: c.id}) }}')" 
									class="btn btn-danger btn-sm" 
									style="width: 70px;">
								Eliminar
							</button>
						</td>
					</tr>
				{% endfor %}
			</tbody>
		</table>
		{% if total_pages > 1 %}
			<nav class="d-flex justify-content-center mt-4" aria-label="Navegación de Respuestas">
				<ul class="pagination">
					<li class="page-item {% if current_page <= 1 %}disabled{% endif %}">
						<a class="page-link" href="{{ path(path_name, {page: current_page - 1}) }}" aria-label="Anterior">
							<span aria-hidden="true">&laquo;</span>
						</a>
					</li>
					{% set start_page = (current_page - 2) > 0 ? (current_page - 2) : 1 %}
					{% set end_page = (current_page + 2) < total_pages ? (current_page + 2) : total_pages %}
					
					{% for i in start_page..end_page %}
						<li class="page-item {% if i == current_page %}active{% endif %}">
							<a class="page-link" href="{{ path(path_name, {page: i}) }}">{{ i }}</a>
						</li>
					{% endfor %}
					<li class="page-item {% if current_page >= total_pages %}disabled{% endif %}">
						<a class="page-link" href="{{ path(path_name, {page: current_page + 1}) }}" aria-label="Siguiente">
							<span aria-hidden="true">&raquo;</span>
						</a>
					</li>
				</ul>
			</nav>
		{% endif %}
	{% endif %}
	<form method="POST" action="{{ path('answer_create') }}">
		<div class="modal fade" id="respuesta" tabindex="-1" aria-labelledby="respuestaLabel" aria-hidden="true">
			<div class="modal-dialog modal-lg modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="respuestaLabel">Crear Respuesta</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
					</div>
					<div class="modal-body" style="text-align-last: center;">
						<div class="mb-3">
							<label for="nombreRespuesta" class="form-label">Nombre de la respuesta</label>
							<input type="text" class="form-control" id="nombreRespuesta" name="nombreRespuesta" required>
                        </div>
						<div class="mb-3">
							<label for="isCorrect" class="form-label">¿Es Correcta?</label>
							<input type="number" class="form-control" id="isCorrect" placeholder="0- No, 1- Si" name="isCorrect" max="1" required>
                        </div>
						<div class="mb-3">
							<label for="questions_id" class="form-label">Seleccionar Pregunta</label>
							<select class="form-control" name="questions_ids" id="questions_id" required> 
								{% for questions_item in questions %}
									<option value="{{ questions_item.id }}"> [{{ questions_item.category.name }}] - {{ questions_item.text }}</option>
								{% endfor %}
							</select>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
						<button type="submit" class="btn btn-primary" name="btnGuardar" id="btnGuardar">Crear Respuesta</button>
					</div>
				</div>
			</div>
		</div>
	</form>
    <form method="POST" action="{{ path('answer_edit') }}">
		<div class="modal fade" id="respuestaEdit" tabindex="-1" aria-labelledby="respuestaEditLabel" aria-hidden="true">
			<div class="modal-dialog modal-lg modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="respuestaEditLabel">Editar Respuesta</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
					</div>
					<div class="modal-body" style="text-align-last: center;">
						<div class="mb-3">
							<label for="nombreRespuestaE" class="form-label">Nombre de la respuesta</label>
							<input type="text" class="form-control" id="nombreRespuestaE" name="nombreRespuestaE" required>
							<input type="hidden" id="idAnswer" name="idAnswer" value="">
                        </div>
						<div class="mb-3">
							<label for="isCorrectE" class="form-label">¿Es Correcta?</label>
							<input type="number" class="form-control" id="isCorrectE" placeholder="0- No, 1- Si" name="isCorrectE" max="1" required>
                        </div>
						<div class="mb-3">
							<label for="questions_id" class="form-label">Seleccionar Pregunta</label>
							<select class="form-control" name="questions_idsE" id="questions_idE" required> 
								{% for questions_item in questions %}
									<option value="{{ questions_item.id }}"> [{{ questions_item.category.name }}] - {{ questions_item.text }}</option>
								{% endfor %}
							</select>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
						<button type="submit" class="btn btn-primary" name="btnGuardar" id="btnGuardar">Editar Respuesta</button>
					</div>
				</div>
			</div>
		</div>
	</form>
{% endblock %}

{% block javascript %}
	<script>
		document.addEventListener('DOMContentLoaded', function () {
            var editModal = document.getElementById('respuestaEdit'); 
            
            if (editModal) {
                editModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    if (!button) return;
                    var id = button.getAttribute('data-id');
                    var text = button.getAttribute('data-text');
                    var isCorrect = button.getAttribute('data-is-correct');
                    var questionId = button.getAttribute('data-question-id');
                    var inputId = document.getElementById('idAnswer');
                    var inputText = document.getElementById('nombreRespuestaE');
                    var inputIsCorrect = document.getElementById('isCorrectE');
                    var selectQuestion = document.getElementById('questions_idE');
                    if (inputId) inputId.value = id || '';
                    if (inputText) inputText.value = text || '';
                    if (inputIsCorrect) inputIsCorrect.value = isCorrect || 0;

                    if (selectQuestion && questionId) {
                        for (var i = 0; i < selectQuestion.options.length; i++) {
                            var option = selectQuestion.options[i];
                            
                            if (option.value == questionId) {
                                option.selected = true; 
                            } else {
                                option.selected = false; 
                            }
                        }
                    }
                });
            }
		});
        function eliminarRespuesta(url) {
            if (!confirm('¿Estás seguro de eliminar esta respuesta?')) {
                return;
            }
            fetch(url, { method: 'DELETE' })
                .then(response => {
                    if (response.status === 409) {
                        return response.json().then(data => {
                            alert('Error: ' + (data.error || 'Problema de relación de datos.'));
                        });
                    } else if (response.ok) {
                        alert('Respuesta eliminada correctamente');
                        location.reload();
                    } else {
                        alert('Error inesperado al eliminar la Respuesta.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error de conexión con el servidor (fetch failed).');
                });
        }

	</script>
{% endblock %}